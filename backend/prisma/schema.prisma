// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  LANDLORD
  TENANT
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String
  role              Role
  firstName         String?
  lastName          String?
  phone             String?
  profileImage      String?
  emailVerified     Boolean   @default(false)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  ownedProperties   Property[] @relation("LandlordProperties")
  createdProperties Property[] @relation("AdminCreatedProperties")
  applications      Application[] @relation("TenantApplications")
  reviewedApps      Application[] @relation("ReviewerApplications")
  leases            Lease[] @relation("TenantLeases")
  createdLeases     Lease[] @relation("AdminCreatedLeases")
  processedPayments Payment[] @relation("AdminProcessedPayments")
  maintenanceRequests MaintenanceRequest[] @relation("TenantRequests")
  assignedMaintenance MaintenanceRequest[] @relation("AssignedMaintenance")
  maintenanceComments MaintenanceComment[]
  sentMessages      Message[] @relation("SentMessages")
  receivedMessages  Message[] @relation("ReceivedMessages")
  payments          Payment[] @relation("TenantPayments")
  notifications     Notification[]

  @@map("users")
}

model Notification {
  id          String    @id @default(uuid())
  userId      String
  title       String
  message     String
  type        String
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())

  // Relationships
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Property {
  id              String    @id @default(uuid())
  name            String
  address         String
  city            String?
  description     String?
  amenities       String[]
  landlordId      String
  createdBy       String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  landlord        User      @relation("LandlordProperties", fields: [landlordId], references: [id])
  creator         User?     @relation("AdminCreatedProperties", fields: [createdBy], references: [id])
  images          PropertyImage[]
  units           Unit[]

  @@map("properties")
}

model PropertyImage {
  id           String    @id @default(uuid())
  propertyId   String
  url          String
  publicId     String?
  isPrimary    Boolean   @default(false)
  createdAt    DateTime  @default(now())

  // Relationships
  property     Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("property_images")
}

enum UnitStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
}

model Unit {
  id                String    @id @default(uuid())
  propertyId       String
  unitNumber       String
  bedrooms          Int
  bathrooms         Decimal?  @db.Decimal(3,1)
  squareFootage    Int?
  rentAmount       Decimal   @db.Decimal(10,2)
  securityDeposit  Decimal?  @db.Decimal(10,2)
  status            UnitStatus @default(AVAILABLE)
  description       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  property         Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  images           UnitImage[]
  applications     Application[]
  leases           Lease[]
  maintenanceRequests MaintenanceRequest[]

  @@unique([propertyId, unitNumber])
  @@map("units")
}

model UnitImage {
  id         String    @id @default(uuid())
  unitId     String
  url        String
  publicId   String?
  isPrimary  Boolean   @default(false)
  createdAt  DateTime  @default(now())

  // Relationships
  unit       Unit      @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@map("unit_images")
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

model Application {
  id                  String    @id @default(uuid())
  unitId              String
  tenantId            String
  status              ApplicationStatus @default(PENDING)
  landlordNotes       String?
  adminNotes          String?
  applicationData     Json?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  reviewedBy          String?
  reviewedAt          DateTime?

  // Relationships
  unit                Unit      @relation(fields: [unitId], references: [id])
  tenant              User      @relation("TenantApplications", fields: [tenantId], references: [id])
  reviewer            User?     @relation("ReviewerApplications", fields: [reviewedBy], references: [id])

  @@map("applications")
}

enum PaymentFrequency {
  MONTHLY
  QUARTERLY
  ANNUALLY
}

enum LeaseStatus {
  ACTIVE
  ENDED
  TERMINATED
}

model Lease {
  id                String    @id @default(uuid())
  unitId            String
  tenantId          String
  startDate         DateTime  @db.Date
  endDate           DateTime  @db.Date
  rentAmount       Decimal   @db.Decimal(10,2)
  paymentFrequency PaymentFrequency @default(MONTHLY)
  securityDeposit  Decimal?  @db.Decimal(10,2)
  terms             String?
  status            LeaseStatus @default(ACTIVE)
  createdBy         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  unit              Unit      @relation(fields: [unitId], references: [id])
  tenant            User      @relation("TenantLeases", fields: [tenantId], references: [id])
  creator           User?     @relation("AdminCreatedLeases", fields: [createdBy], references: [id])
  payments          Payment[]

  @@map("leases")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  OVERDUE
}

model Payment {
  id                  String    @id @default(uuid())
  leaseId             String?
  tenantId            String
  amount              Decimal   @db.Decimal(10,2)
  status              PaymentStatus @default(PENDING)
  mpesaReceiptNumber  String?   @unique
  phoneNumber         String?
  method              String    @default("MPESA")
  notes               String?
  paidAt              DateTime?
  processedBy         String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relationships
  lease               Lease?    @relation(fields: [leaseId], references: [id])
  tenant              User      @relation("TenantPayments", fields: [tenantId], references: [id])
  processor           User?     @relation("AdminProcessedPayments", fields: [processedBy], references: [id])

  @@map("payments")
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MaintenanceStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model MaintenanceRequest {
  id          String    @id @default(uuid())
  unitId      String
  tenantId    String
  category    String?
  description String
  priority    Priority  @default(MEDIUM)
  status      MaintenanceStatus @default(OPEN)
  assignedTo  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relationships
  unit        Unit      @relation(fields: [unitId], references: [id])
  tenant      User      @relation("TenantRequests", fields: [tenantId], references: [id])
  assignee    User?     @relation("AssignedMaintenance", fields: [assignedTo], references: [id])
  comments    MaintenanceComment[]

  @@map("maintenance_requests")
}

model MaintenanceComment {
  id          String    @id @default(uuid())
  requestId   String
  userId      String
  comment     String
  createdAt   DateTime  @default(now())

  // Relationships
  request     MaintenanceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  user        User               @relation(fields: [userId], references: [id])

  @@map("maintenance_comments")
}

model Message {
  id          String    @id @default(uuid())
  senderId    String
  receiverId  String
  subject     String?
  body        String
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())

  // Relationships
  sender      User      @relation("SentMessages", fields: [senderId], references: [id])
  receiver    User      @relation("ReceivedMessages", fields: [receiverId], references: [id])

  @@map("messages")
}
